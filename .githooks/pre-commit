#!/bin/sh
# Prevent committing secrets

set -e

FILES=$(git diff --cached --name-only --diff-filter=ACM)
[ -z "$FILES" ] && exit 0

# Patterns to scan for (high-signal)
PATTERN='(GROQ_API_KEY=|OPENAI_API_KEY=|github_pat_[A-Za-z0-9_]{20,}|ghp_[A-Za-z0-9]{20,}|xox[baprsa]-[A-Za-z0-9-]{10,}|AIza[0-9A-Za-z-_]{35}|AKIA[0-9A-Z]{16}|-----BEGIN [A-Z ]+PRIVATE KEY-----)'

echo "$FILES" | while read -r file; do
  # Skip binary files
  if git diff --cached --numstat -- "$file" | awk '{exit ($3=="-") ? 1 : 0}'; then
    continue
  fi
  if grep -E -n "$PATTERN" -- "$file" >/dev/null 2>&1; then
    echo "\n[SECURITY] Secret-like content detected in: $file" >&2
    echo "Commit aborted. Please remove secrets and use environment variables (.env)." >&2
    echo "You can whitelist intentionally safe examples by replacing with placeholders (e.g., YOUR_GROQ_API_KEY)." >&2
    exit 1
  fi
done

exit 0
